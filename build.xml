<project name="Workspace Service" default="test" basedir=".">

  <description>
      Build file for the Workspace Service
  </description>

  <!-- set global properties for this build -->
  <property name="package" value="workspace service"/>
  <property name="src" location="src"/>
  <property name="lib" location="lib"/>
  <!--<property name="out.lib"	location="${DEPLOY_RUNTIME}/lib/gen_java_types"/>-->
  <property name="dist" location="dist"/>
  <!--<property name="out.bin" location="${TARGET}/bin"/>
  <property name="out.jar" location="${TARGET}/lib"/>-->
  <property name="classes" location="classes"/>
  <!--<property name="test" location="test"/>-->
  <property name="jar.file" value="WorkspaceService.jar"/>
  <property name="war.file" value="WorkspaceService.war"/>
  <property name="war.dir" value="war"/>
  <!--<property name="sh.file" value="gen_java_types"/>
  <property name="test.file" value="test_gen_java_types.sh"/>-->

  <fileset dir="../jars/lib/jars/" id="libfiles">
    <include name="apache_commons/commons-codec-1.8.jar"/>
    <include name="apache_commons/commons-io-2.4.jar"/>
    <include name="apache_commons/commons-lang3-3.1.jar"/>
    <include name="apache_commons/commons-logging-1.1.1.jar"/>
    <include name="apache_commons/http/httpclient-4.2.5.jar"/>
    <include name="apache_commons/http/httpcore-4.2.4.jar"/>
    <include name="apache_commons/http/httpmime-4.2.5.jar"/>
    <include name="bson4jackson/bson4jackson-2.1.0.jar"/>
    <include name="ini4j/ini4j-0.5.2.jar"/>
    <include name="jackson/jackson-all-1.9.11.jar"/>
    <include name="jackson/jackson-annotations-2.1.4.jar"/>
    <include name="jackson/jackson-core-2.1.4.jar"/>
    <include name="jackson/jackson-databind-2.1.4.jar"/>
    <include name="jetty/jetty-all-7.0.0.jar"/>
    <include name="jna/jna-3.4.0.jar"/>
    <include name="jongo/jongo-0.4.jar"/>
    <include name="junit/junit-4.9.jar"/>
    <include name="kbase/auth/kbase-auth-8f670e9.jar"/>
    <include name="mongo/mongo-java-driver-2.11.2.jar"/>
    <include name="servlet/servlet-api-2.5.jar"/>
    <include name="syslog4j/syslog4j-0.9.46.jar"/>
  </fileset>

  <target name="init" description="make directories">
    <!-- Create the output directory structure-->
    <mkdir dir="${classes}"/>
    <mkdir dir="${dist}"/>
    <!--<mkdir dir="${test}"/>
    <mkdir dir="${out.lib}"/>-->
  </target>
	
  <target name="compile" depends="init" description="compile the source">
    <!-- Compile class files-->
    <javac destdir="${classes}" srcdir="${src}" includeantruntime="false"
      debug="true" classpathref="compile.classpath" />
    <!-- Make main jar file-->
    <jar destfile="${dist}/${jar.file}" basedir="${classes}">
      <!--<manifest>
        <attribute name="Main-Class" value="us.kbase.scripts.JavaTypeGenerator"/>
      </manifest>-->
    </jar>
    <mkdir dir="${war.dir}/lib"/>
    <copy todir="${war.dir}/lib/" flatten="true">
      <fileset refid="libfiles"/>
    </copy>
    <war destfile="dist/${war.file}" webxml="${war.dir}/web.xml">
      <classes dir="${classes}"/>
      <lib dir="${war.dir}/lib/"/>
    </war>
    <!-- Remove uncompressed class files and libs-->
    <delete dir="${classes}"/>
    <delete dir="${war.dir}/lib"/>
  </target>

  <path id="compile.classpath">
    <fileset refid="libfiles"/>
  </path>

  <path id="test.classpath">
    <path refid="compile.classpath"/>
    <fileset dir="${dist}/">
      <include name="*.jar"/>
    </fileset>
  </path>

  <target name="javadoc" description="build javadocs">
    <javadoc access="protected" author="false" classpathref="compile.classpath"
      destdir="docs" nodeprecated="false" nodeprecatedlist="false"
      noindex="false" nonavbar="false" notree="false"
      packagenames="us.kbase.shock.client,us.kbase.shock.client.exceptions"
      source="1.7" sourcepath="src" splitindex="true" use="true" version="true">
      <link href="http://download.oracle.com/javase/7/docs/api/"/>
      <link href="http://fasterxml.github.io/jackson-core/javadoc/2.1.0/"/>
    </javadoc>
  </target>

  <!--<target name="compile_and_bin" depends="compile" description="compile and create shell file in dev_container/bin" >-->
    <!-- Define list of lib-jar files-->
    <!-- Define absolute path to main jar file-->
    <!--<property name="jar.absolute.path" location="${dist}/${jar.file}"/>-->
    <!-- Define classpath string with : delimiter from list of lib-jar files-->
    <!--<pathconvert targetos="unix" property="lib.classpath" refid="compile.classpath"/>-->
    <!-- Create main shell script-->
    <!--<echo file="${dist}/${sh.file}">#!/bin/sh
java -cp ${lib.classpath}:${jar.absolute.path} us.kbase.scripts.JavaTypeGenerator $@
    </echo>
    <chmod file="${dist}/${sh.file}" perm="a+x"/>-->
    <!-- Copy main shell script into dev_container bin folder-->
    <!--<copy todir="${out.bin}" flatten="true">
      <fileset file="${dist}/${sh.file}"/>
    </copy>
    <chmod file="${out.bin}/${sh.file}" perm="a+x"/>
  </target>-->

  <target name="test" depends="compile" description="run tests">
    <fail unless="test.shock.url" message="property test.shock.url not set."/>
    <fail unless="test.mongo.host" message="property test.mongo.host not set."/>
    <fail unless="test.mongo.db" message="property test.mongo.db not set."/>
    <fail unless="test.mongo.db2" message="property test.mongo.db2 not set."/>
    <fail unless="test.user1" message="property test.user1 not set."/>
    <fail unless="test.pwd1" message="property test.pwd1 not set."/>
    <fail unless="test.user1" message="property test.user1 not set."/>
    <fail unless="test.pwd2" message="property test.pwd2 not set."/>
    <fail unless="test.user.noemail" message="property test.user.noemail not set."/>
    <fail unless="test.pwd.noemail" message="property test.pwd.noemail not set."/>
    <echo message="starting ${package} tests"/>
    <condition property="test.mongo.user" else="" >
      <isset property="test.mongo.user" />
    </condition>
    <condition property="test.mongo.pwd" else="" >
      <isset property="test.mongo.pwd" />
    </condition>
    <junit haltonfailure="false">
      <classpath refid="test.classpath"/>
      <formatter type="plain" usefile="false" />
      <sysproperty key="test.shock.url" value="${test.shock.url}"/>
      <sysproperty key="test.mongo.host" value="${test.mongo.host}"/>
      <sysproperty key="test.mongo.db" value="${test.mongo.db}"/>
      <sysproperty key="test.mongo.db2" value="${test.mongo.db2}"/>
      <sysproperty key="test.mongo.user" value="${test.mongo.user}"/>
      <sysproperty key="test.mongo.pwd" value="${test.mongo.pwd}"/>
      <sysproperty key="test.user1" value="${test.user1}"/>
      <sysproperty key="test.pwd1" value="${test.pwd1}"/>
      <sysproperty key="test.user2" value="${test.user2}"/>
      <sysproperty key="test.pwd2" value="${test.pwd2}"/>
      <sysproperty key="test.user.noemail" value="${test.user.noemail}"/>
      <sysproperty key="test.pwd.noemail" value="${test.pwd.noemail}"/>
      <test name="us.kbase.shock.client.test.ShockTests"/>
      <test name="us.kbase.workspace.database.mongo.test.ShockBackendTest"/>
      <test name="us.kbase.workspace.database.mongo.test.GridFSBackendTest"/>
      <test name="us.kbase.workspace.workspaces.test.TestWorkspaces"/>
      <test name="us.kbase.workspace.test.JSONRPCLayerTest"/>
    </junit>
      
    <!-- Define absolute path to main jar file-->
    <!--<property name="jar.absolute.path" location="${dist}/${jar.file}"/>-->
    <!-- Define classpath string with : delimiter from list of lib-jar files-->
    <!--<pathconvert targetos="unix" property="lib.classpath" refid="compile.classpath"/>-->
    <!-- Create testing shell script-->
    <!--<echo file="${test}/${test.file}">#!/bin/sh
java -cp ${lib.classpath}:${jar.absolute.path} org.junit.runner.JUnitCore us.kbase.scripts.tests.MainTest
    </echo>
    <chmod file="${test}/${test.file}" perm="a+x"/>-->
  </target>

  <!--<target name="dist" depends="compile" description="generate the distribution" >-->
    <!-- Copy necessary lib-jars into runtime lib subfolder-->
    <!--<copy todir="${out.lib}" flatten="true">
      <fileset dir="${lib}">
        <include name="*.jar"/>
      </fileset>
    </copy>-->
    <!-- Copy main jar file into deployment lib folder-->
    <!--<copy todir="${out.jar}" flatten="true">
      <fileset file="${dist}/${jar.file}"/>
    </copy>-->
    <!-- Define list of lib-jar files-->
    <!-- Define absolute path to main jar file-->
    <!--<property name="jar.absolute.path" location="${out.jar}/${jar.file}"/>-->
    <!-- Define classpath string with : delimiter from list of lib-jar files-->
    <!--<pathconvert targetos="unix" property="lib.classpath" refid="compile.classpath">
      <map from="${lib}" to="${out.lib}"/>
    </pathconvert>-->
    <!-- Create main shell script-->
    <!--<echo file="${dist}/${sh.file}">#!/bin/sh
java -cp ${lib.classpath}:${jar.absolute.path} us.kbase.scripts.JavaTypeGenerator $@
    </echo>
    <chmod file="${dist}/${sh.file}" perm="a+x"/>-->
    <!-- Copy main shell script into deployment bin folder-->
    <!--<copy todir="${out.bin}" flatten="true">
      <fileset file="${dist}/${sh.file}"/>
    </copy>
    <chmod file="${out.bin}/${sh.file}" perm="a+x"/>
  </target>-->

  <target name="clean" description="clean up" >
    <!-- Clean up internal temporary files and folders-->
    <delete dir="${classes}"/>
    <delete dir="${dist}"/>
    <!--<delete dir="${test}"/>-->
  </target>
</project>

